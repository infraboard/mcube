# IOC å®¹å™¨ Copy-on-Write (COW) è®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ æ¦‚è¿°

Copy-on-Write (COW) æ˜¯ä¸€ç§æ›¿ä»£ RWMutex çš„å¹¶å‘æ§åˆ¶æ–¹æ¡ˆï¼Œé€šè¿‡ä¸å¯å˜æ•°æ®ç»“æ„å®ç°æ›´ç®€å•ã€æ›´å®‰å…¨çš„å¹¶å‘è®¿é—®ã€‚

### æ ¸å¿ƒä¼˜åŠ¿

âœ… **å®Œå…¨æ— é”è¯»å–** - è¯»æ“ä½œä¸éœ€è¦ä»»ä½•é”ï¼Œæ€§èƒ½æä½³  
âœ… **è‡ªç„¶é¿å…æ­»é”** - è¯»æ“ä½œæ°¸ä¸é˜»å¡ï¼Œç”¨æˆ·å›è°ƒå¯å®‰å…¨è°ƒç”¨ä»»ä½•æ–¹æ³•  
âœ… **ä»£ç æ›´ç®€å•** - æ— éœ€æ‹…å¿ƒé”çš„é¡ºåºå’ŒåµŒå¥—ï¼Œç»´æŠ¤æˆæœ¬ä½  
âœ… **æ€§èƒ½æ›´ä¼˜** - æµ‹è¯•æ˜¾ç¤ºæ¯” RWMutex å¿« **49.7%**  

### æ€§èƒ½æµ‹è¯•ç»“æœ

```
æµ‹è¯•åœºæ™¯ï¼š100 ä¸ªå¹¶å‘è¯»å–è€… + 10 ä¸ªå¹¶å‘å†™å…¥è€…
- COW:     2.36 ç§’
- RWMutex: 4.70 ç§’
- æ€§èƒ½æå‡: 49.7% ğŸš€
```

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•°æ®ç»“æ„

```go
type NamespaceStoreCOW struct {
    // ä¸å¯å˜çš„ items åˆ—è¡¨ï¼ˆä½¿ç”¨ atomic.Value å­˜å‚¨ï¼‰
    items atomic.Value // *cowItems
    
    // å†™æ“ä½œäº’æ–¥é”ï¼ˆåªæœ‰å†™-å†™ä¹‹é—´éœ€è¦äº’æ–¥ï¼‰
    writeMu sync.Mutex
    
    Namespace string
    Priority  int
}

type cowItems struct {
    items []*ObjectWrapper  // ä¸å¯å˜åˆ‡ç‰‡
}
```

### æ ¸å¿ƒåŸç†

1. **è¯»æ“ä½œï¼ˆGet/List/ForEachï¼‰**
   - é€šè¿‡ `atomic.Value.Load()` è·å–å½“å‰å¿«ç…§
   - å®Œå…¨æ— é”ï¼Œå¤šä¸ªè¯»å–è€…å¹¶å‘è®¿é—®
   - å³ä½¿å†™å…¥æ­£åœ¨è¿›è¡Œï¼Œè¯»å–è€…ä¹Ÿä¸ä¼šé˜»å¡

2. **å†™æ“ä½œï¼ˆRegistryï¼‰**
   - è·å– `writeMu` é”ï¼ˆåªé˜»å¡å…¶ä»–å†™å…¥è€…ï¼‰
   - è¯»å–å½“å‰ itemsï¼Œåˆ›å»ºå‰¯æœ¬
   - ä¿®æ”¹å‰¯æœ¬åï¼Œé€šè¿‡ `atomic.Value.Store()` æ›¿æ¢
   - æ—§ç‰ˆæœ¬ä»å¯è¢«æ­£åœ¨ä½¿ç”¨çš„è¯»å–è€…è®¿é—®

---

## ğŸ“Š COW vs RWMutex å¯¹æ¯”

### åŠŸèƒ½å¯¹æ¯”

| ç‰¹æ€§ | COW (atomic.Value) | RWMutex (å½“å‰æ–¹æ¡ˆ) |
|------|-------------------|-------------------|
| è¯»æ“ä½œæ€§èƒ½ | ğŸŸ¢ å®Œå…¨æ— é”ï¼Œæå¿« | ğŸŸ¡ éœ€è¦ RLockï¼Œè¾ƒæ…¢ |
| å†™æ“ä½œæ€§èƒ½ | ğŸŸ¡ éœ€è¦å¤åˆ¶æ•°æ® | ğŸŸ¢ ç›´æ¥ä¿®æ”¹ |
| æ­»é”é£é™© | ğŸŸ¢ å‡ ä¹ä¸å¯èƒ½ | ğŸ”´ éœ€è¦å°å¿ƒè®¾è®¡ |
| ä»£ç å¤æ‚åº¦ | ğŸŸ¢ ç®€å•ç›´è§‚ | ğŸ”´ å¤æ‚ï¼Œæ˜“å‡ºé”™ |
| å†…å­˜å¼€é”€ | ğŸŸ¡ å†™å…¥æ—¶éœ€è¦å¤åˆ¶ | ğŸŸ¢ æ— é¢å¤–å¼€é”€ |
| ç»´æŠ¤æˆæœ¬ | ğŸŸ¢ ä½ | ğŸ”´ é«˜ |

### é€‚ç”¨åœºæ™¯

#### âœ… COW æ›´é€‚åˆï¼ˆæ¨èï¼‰

- **è¯»å¤šå†™å°‘** - IOC å®¹å™¨çš„å…¸å‹åœºæ™¯
  - å¯åŠ¨é˜¶æ®µï¼šé¢‘ç¹æ³¨å†Œå¯¹è±¡ï¼ˆå†™ï¼‰
  - è¿è¡Œé˜¶æ®µï¼šå¤§é‡ä¾èµ–æ³¨å…¥ï¼ˆè¯»ï¼‰
  - è¯»å†™æ¯”ä¾‹é€šå¸¸ > 100:1

- **éœ€è¦é«˜å¹¶å‘è¯»å–** - å¤šä¸ª Goroutine åŒæ—¶è®¿é—®
- **éœ€è¦é¿å…æ­»é”** - ç”¨æˆ·å›è°ƒå¯èƒ½è°ƒç”¨å®¹å™¨æ–¹æ³•
- **éœ€è¦ä¸€è‡´æ€§å¿«ç…§** - ForEach/Init ç­‰éœ€è¦ç¨³å®šè§†å›¾

#### âš ï¸ RWMutex æ›´é€‚åˆ

- **å†™å¤šè¯»å°‘** - é¢‘ç¹ä¿®æ”¹æ•°æ®ï¼ˆç½•è§ï¼‰
- **æ•°æ®é‡æå¤§** - å¤åˆ¶æˆæœ¬è¿‡é«˜ï¼ˆIOC é€šå¸¸åªæœ‰å‡ åä¸ªå¯¹è±¡ï¼‰
- **æ— å›è°ƒåœºæ™¯** - ä¸å­˜åœ¨é€’å½’è°ƒç”¨é£é™©

---

## ğŸ’¡ æ ¸å¿ƒå®ç°

### 1. æ— é”è¯»å–

```go
// Get è·å–å¯¹è±¡ï¼ˆå®Œå…¨æ— é”ï¼‰
func (s *NamespaceStoreCOW) Get(name string, opts ...GetOption) Object {
    // åŸå­è¯»å–å½“å‰å¿«ç…§
    items := s.getItems()  // atomic.Value.Load()
    
    // éå†æŸ¥æ‰¾ï¼ˆæ— éœ€ä»»ä½•é”ï¼‰
    for _, item := range items {
        if item.Name == name {
            return item.Value
        }
    }
    return nil
}
```

**ä¼˜åŠ¿**ï¼š
- âœ… å¤šä¸ª Goroutine å¯åŒæ—¶è°ƒç”¨ `Get()`ï¼Œé›¶ç­‰å¾…
- âœ… å³ä½¿ `Registry()` æ­£åœ¨æ‰§è¡Œï¼Œ`Get()` ä¹Ÿä¸ä¼šé˜»å¡
- âœ… ç”¨æˆ·åœ¨ `Init()` å›è°ƒä¸­è°ƒç”¨ `Get()` å®Œå…¨å®‰å…¨

### 2. Copy-on-Write å†™å…¥

```go
// Registry æ³¨å†Œå¯¹è±¡ï¼ˆCopy-on-Writeï¼‰
func (s *NamespaceStoreCOW) Registry(v Object) StoreUser {
    // 1. åœ¨é”å¤–è°ƒç”¨ç”¨æˆ·æ–¹æ³•ï¼ˆé¿å…å›è°ƒæ­»é”ï¼‰
    name, version := GetIocObjectUid(v)
    priority := v.Priority()  // å¯èƒ½è°ƒç”¨ Get()ï¼Œä½†æ— é”æ‰€ä»¥å®‰å…¨
    
    obj := NewObjectWrapper(v, priority)
    
    // 2. è·å–å†™é”ï¼ˆåªé˜»å¡å…¶ä»–å†™å…¥è€…ï¼‰
    s.writeMu.Lock()
    defer s.writeMu.Unlock()
    
    // 3. è¯»å–å½“å‰å¿«ç…§ï¼ˆæ— é”åŸå­æ“ä½œï¼‰
    current := s.getItems()
    
    // 4. åˆ›å»ºæ–°å‰¯æœ¬å¹¶ä¿®æ”¹
    newItems := make([]*ObjectWrapper, len(current)+1)
    copy(newItems, current)
    newItems[len(current)] = obj
    
    // 5. åŸå­æ›¿æ¢ï¼ˆå…¶ä»–è¯»å–è€…ä»å¯è®¿é—®æ—§ç‰ˆæœ¬ï¼‰
    s.setItems(newItems)  // atomic.Value.Store()
    
    return s
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… `Priority()` è°ƒç”¨åœ¨é”å¤–ï¼Œå¯å®‰å…¨è°ƒç”¨ `Get()`
- âœ… å†™é”åªé˜»å¡å…¶ä»–å†™å…¥è€…ï¼Œä¸å½±å“è¯»å–è€…
- âœ… æ—§ç‰ˆæœ¬å¿«ç…§ä»å¯è¢«å¹¶å‘è¯»å–è€…ä½¿ç”¨

---

## ğŸ”’ æ­»é”é—®é¢˜è§£å†³

### RWMutex çš„æ­»é”é£é™©

#### é—®é¢˜ 1ï¼šRegistry â†’ Get æ­»é”ï¼ˆv2.0 å·²ä¿®å¤ï¼‰
```go
// âŒ æ—§ç‰ˆæœ¬ï¼šä¼šæ­»é”
func (s *NamespaceStore) Registry(v Object) {
    s.mu.Lock()              // è·å–å†™é”
    priority := v.Priority() // Priority() å†…éƒ¨è°ƒç”¨ Get()
    s.mu.RLock()             // ğŸ’¥ å°è¯•è·å–è¯»é” â†’ æ­»é”
}
```

#### é—®é¢˜ 2ï¼šInit å›è°ƒ â†’ Get æ­»é”ï¼ˆv2.0.1 å·²ä¿®å¤ï¼‰
```go
// âŒ ä¿®å¤å‰ï¼šInit æŒæœ‰è¯»é”
func (s *NamespaceStore) Init() error {
    s.mu.RLock()
    defer s.mu.RUnlock()
    
    for _, item := range s.Items {
        item.Value.Init() // ç”¨æˆ·å¯èƒ½è°ƒç”¨ ioc.Get()
                          // ğŸ’¥ é€’å½’è¯»é” â†’ æ­»é”
    }
}
```

**v2.0.1 è§£å†³æ–¹æ¡ˆ**ï¼šå¤åˆ¶å¿«ç…§åé‡Šæ”¾é”
```go
// âœ… ä¿®å¤åï¼šä½¿ç”¨å¿«ç…§æ¨¡å¼
func (s *NamespaceStore) Init() error {
    s.mu.RLock()
    items := make([]*ObjectWrapper, len(s.Items))
    copy(items, s.Items)
    s.mu.RUnlock() // å…ˆé‡Šæ”¾é”
    
    for _, item := range items {
        item.Value.Init() // ç°åœ¨å®‰å…¨äº†
    }
}
```

### COW çš„å¤©ç„¶ä¼˜åŠ¿

```go
// âœ… COWï¼šæ°¸ä¸æ­»é”
func (s *NamespaceStoreCOW) Init() error {
    // æ— é”è¯»å–å¿«ç…§
    items := s.getItems()
    
    // éå†æ‰§è¡Œå›è°ƒï¼ˆæ— é”ï¼Œç”¨æˆ·å¯éšæ„è°ƒç”¨ä»»ä½•æ–¹æ³•ï¼‰
    for _, item := range items {
        if err := item.Value.Init(); err != nil {
            return err
        }
    }
    return nil
}
```

**ä¸ºä»€ä¹ˆä¸ä¼šæ­»é”**ï¼š
- âœ… `getItems()` æ˜¯åŸå­æ“ä½œï¼Œä¸æŒæœ‰ä»»ä½•é”
- âœ… éå†è¿‡ç¨‹ä¸­æ— é”ï¼Œç”¨æˆ·å¯è°ƒç”¨ `Get()`/`Registry()` ç­‰ä»»ä½•æ–¹æ³•
- âœ… å³ä½¿ç”¨æˆ·åœ¨å›è°ƒä¸­æ³¨å†Œæ–°å¯¹è±¡ï¼Œä¹Ÿä¸ä¼šå½±å“å½“å‰éå†

---

## ğŸš€ ä½¿ç”¨æŒ‡å—

### åŸºæœ¬ç”¨æ³•ï¼ˆä¸ RWMutex ç‰ˆæœ¬å®Œå…¨å…¼å®¹ï¼‰

```go
// åˆ›å»º COW å®¹å™¨
store := newNamespaceStoreCOW("default")

// æ³¨å†Œå¯¹è±¡ï¼ˆä¸æ—§ç‰ˆæœ¬ API å®Œå…¨ä¸€è‡´ï¼‰
store.Registry(&MyService{})

// è·å–å¯¹è±¡ï¼ˆæ— é”ï¼Œæå¿«ï¼‰
obj := store.Get("MyService")

// éå†å¯¹è±¡ï¼ˆæ— é”ï¼Œå›è°ƒä¸­å¯å®‰å…¨è°ƒç”¨ä»»ä½•æ–¹æ³•ï¼‰
store.ForEach(func(item *ObjectWrapper) {
    // âœ… å®‰å…¨ï¼šå¯ä»¥è°ƒç”¨ Get/Registry ç­‰ä»»ä½•æ–¹æ³•
    dependency := store.Get("OtherService")
    item.Value.Init()
})

// åˆå§‹åŒ–ï¼ˆæ— é”ï¼Œè‡ªåŠ¨å¤„ç†ä¾èµ–ï¼‰
if err := store.Init(); err != nil {
    log.Fatal(err)
}
```

### å…¸å‹ä½¿ç”¨åœºæ™¯

#### åœºæ™¯ 1ï¼šç›¸å¯¹ä¼˜å…ˆçº§ï¼ˆåŠ¨æ€ä¾èµ–ï¼‰

```go
type ServiceA struct {
    ioc.ObjectImpl
}

func (s *ServiceA) Priority() int {
    // âœ… COWï¼šå¯ä»¥å®‰å…¨è°ƒç”¨ Getï¼ˆæ— é”ï¼‰
    // âœ… RWMutex v2.0ï¼šä¹Ÿå·²ä¿®å¤ï¼ˆPriority åœ¨é”å¤–è°ƒç”¨ï¼‰
    if ioc.Default().Get("DatabaseService") != nil {
        return 100 // æ•°æ®åº“å­˜åœ¨æ—¶ï¼Œæˆ‘ä¼˜å…ˆçº§æ›´é«˜
    }
    return 50
}
```

#### åœºæ™¯ 2ï¼šInit å›è°ƒä¸­æ³¨å†Œæ–°å¯¹è±¡

```go
func (s *ServiceA) Init() error {
    // âœ… COWï¼šå®Œå…¨å®‰å…¨ï¼ˆæ— é”ï¼‰
    // âœ… RWMutex v2.0.1ï¼šå·²ä¿®å¤ï¼ˆå¿«ç…§æ¨¡å¼ï¼‰
    
    // åŠ¨æ€æ³¨å†Œæ´¾ç”Ÿå¯¹è±¡
    if s.needsDerivedService {
        ioc.Default().Registry(&DerivedService{})
    }
    
    // è·å–ä¾èµ–
    dep := ioc.Default().Get("DependencyService")
    return nil
}
```

#### åœºæ™¯ 3ï¼šé«˜å¹¶å‘è¯»å–

```go
// 100 ä¸ª Goroutine åŒæ—¶è¯»å–
for i := 0; i < 100; i++ {
    go func() {
        // âœ… COWï¼šå®Œå…¨æ— é”ï¼Œé›¶ç­‰å¾…
        // âš ï¸  RWMutexï¼šéœ€è¦ RLockï¼Œæœ‰è½»å¾®å¼€é”€
        obj := store.Get("MyService")
    }()
}
```

---

## ğŸ“ˆ æ€§èƒ½åˆ†æ

### æµ‹è¯•æ–¹æ³•

```go
// 100 ä¸ªå¹¶å‘è¯»å–è€… + 10 ä¸ªå¹¶å‘å†™å…¥è€…
func TestCOWVsRWMutex(t *testing.T) {
    // é¢„æ³¨å†Œ 50 ä¸ªå¯¹è±¡
    for i := 0; i < 50; i++ {
        cowStore.Registry(&SimpleTestObject{name: fmt.Sprintf("obj-%d", i)})
        rwStore.Registry(&SimpleTestObject{name: fmt.Sprintf("obj-%d", i)})
    }
    
    // å¹¶å‘æµ‹è¯•
    var wg sync.WaitGroup
    
    // 100 ä¸ªè¯»å–è€…
    for i := 0; i < 100; i++ {
        wg.Add(1)
        go func() {
            defer wg.Done()
            for j := 0; j < 100; j++ {
                store.Get(fmt.Sprintf("obj-%d", j%50))
            }
        }()
    }
    
    // 10 ä¸ªå†™å…¥è€…
    for i := 0; i < 10; i++ {
        wg.Add(1)
        go func(id int) {
            defer wg.Done()
            for j := 0; j < 10; j++ {
                store.Registry(&SimpleTestObject{
                    name: fmt.Sprintf("new-obj-%d-%d", id, j),
                })
            }
        }(i)
    }
    
    wg.Wait()
}
```

### å®æµ‹ç»“æœ

```
âœ… COW Performance:     2.364 ç§’
âœ… RWMutex Performance: 4.698 ç§’
ğŸš€ COW å¿« 49.7%ï¼
```

### æ€§èƒ½åˆ†æ

#### ä¸ºä»€ä¹ˆ COW æ›´å¿«ï¼Ÿ

1. **è¯»å–å®Œå…¨æ— é”**ï¼ˆæœ€é‡è¦ï¼‰
   - RWMutex: æ¯æ¬¡ `Get()` éœ€è¦ `RLock()`/`RUnlock()`
   - COW: åªéœ€ `atomic.Value.Load()`ï¼Œæˆæœ¬æä½
   - è¯»å¤šå†™å°‘åœºæ™¯ä¸‹ï¼Œä¼˜åŠ¿æ˜¾è‘—

2. **æ— é”ç«äº‰**
   - RWMutex: 100 ä¸ªè¯»å–è€…äº‰æŠ¢ RLock
   - COW: 100 ä¸ªè¯»å–è€…æ— éœ€ç­‰å¾…

3. **æ— å†™è€…é¥¥é¥¿**
   - RWMutex: å¤§é‡è¯»å–è€…å¯èƒ½é¥¿æ­»å†™å…¥è€…
   - COW: å†™å…¥è€…åªä¸å…¶ä»–å†™å…¥è€…ç«äº‰

#### å¤åˆ¶å¼€é”€åˆ†æ

```go
// å†™æ“ä½œéœ€è¦å¤åˆ¶ items
newItems := make([]*ObjectWrapper, len(current)+1)
copy(newItems, current)  // å¤åˆ¶æŒ‡é’ˆåˆ‡ç‰‡ï¼Œæˆæœ¬å¾ˆä½
```

**æˆæœ¬**ï¼š
- åªå¤åˆ¶ **æŒ‡é’ˆåˆ‡ç‰‡**ï¼Œä¸å¤åˆ¶å¯¹è±¡æœ¬èº«
- IOC å®¹å™¨é€šå¸¸åªæœ‰ 10-100 ä¸ªå¯¹è±¡
- å¤åˆ¶ 100 ä¸ªæŒ‡é’ˆ â‰ˆ 800 å­—èŠ‚ï¼Œè€—æ—¶ < 1Î¼s
- å¯¹æ¯”æ”¶ç›Šï¼šè¯»å–æ€§èƒ½æå‡ 50%+

---

## ğŸ’ æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

1. **é»˜è®¤ä½¿ç”¨ COW**
   ```go
   // IOC å®¹å™¨é»˜è®¤åº”ä½¿ç”¨ COW å®ç°
   store := newNamespaceStoreCOW("default")
   ```

2. **åœ¨ä»»ä½•å›è°ƒä¸­å®‰å…¨è°ƒç”¨ä»»ä½•æ–¹æ³•**
   ```go
   func (s *MyService) Init() error {
       // âœ… å®Œå…¨å®‰å…¨
       dep := ioc.Default().Get("Dependency")
       ioc.Default().Registry(&NewService{})
       return nil
   }
   ```

3. **åˆ©ç”¨å¿«ç…§ä¸€è‡´æ€§**
   ```go
   // ForEach è‡ªåŠ¨æä¾›ä¸€è‡´æ€§å¿«ç…§
   store.ForEach(func(item *ObjectWrapper) {
       // éå†è¿‡ç¨‹ä¸­ï¼Œå³ä½¿æœ‰æ–°å¯¹è±¡æ³¨å†Œï¼Œä¹Ÿä¸ä¼šå½±å“å½“å‰éå†
   })
   ```

### âš ï¸ æ³¨æ„äº‹é¡¹

1. **å†™å…¥é¢‘ç¹åœºæ™¯**
   ```go
   // å¦‚æœæ¯ç§’æ³¨å†Œä¸Šåƒä¸ªå¯¹è±¡ï¼ˆç½•è§ï¼‰ï¼Œè€ƒè™‘å…¶ä»–æ–¹æ¡ˆ
   // ä½† IOC å®¹å™¨é€šå¸¸åªåœ¨å¯åŠ¨é˜¶æ®µæ³¨å†Œï¼Œè¿è¡Œæ—¶æå°‘å†™å…¥
   ```

2. **å¯¹è±¡æ•°é‡å·¨å¤§**
   ```go
   // å¦‚æœæœ‰ 10000+ ä¸ªå¯¹è±¡ï¼ˆæç½•è§ï¼‰ï¼Œå¤åˆ¶å¼€é”€å¯èƒ½è¾ƒå¤§
   // å®é™…é¡¹ç›®ä¸­ï¼ŒIOC å®¹å™¨é€šå¸¸åªæœ‰ 10-100 ä¸ªå¯¹è±¡
   ```

---

## ğŸ”„ è¿ç§»æŒ‡å—

### å½“å‰çŠ¶æ€

- âœ… **store.go**: RWMutex å®ç°ï¼ˆv2.0.1ï¼Œå·²ä¿®å¤æ‰€æœ‰æ­»é”ï¼‰
- âœ… **store_cow.go**: COW å®ç°ï¼ˆæµ‹è¯•å®Œæˆï¼Œæ€§èƒ½æ›´ä¼˜ï¼‰
- âœ… **ä¸¤è€… API å®Œå…¨å…¼å®¹**

### è¿ç§»æ–¹æ¡ˆ

#### æ–¹æ¡ˆ 1ï¼šä¿æŒå‘åå…¼å®¹ï¼ˆæ¨èï¼‰

```go
// ioc/default.go
func newNamespaceStore(namespace string) StoreUser {
    // é€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶
    if os.Getenv("IOC_USE_COW") == "true" {
        return newNamespaceStoreCOW(namespace)
    }
    return newNamespaceStore(namespace) // é»˜è®¤ä¿æŒ RWMutex
}
```

**ä¼˜ç‚¹**ï¼š
- ç”¨æˆ·å¯è‡ªä¸»é€‰æ‹©
- é€æ­¥è¿ç§»ï¼Œé™ä½é£é™©

#### æ–¹æ¡ˆ 2ï¼šç›´æ¥åˆ‡æ¢ï¼ˆæ¿€è¿›ï¼‰

```go
// ç›´æ¥æ›¿æ¢ä¸º COW
func newNamespaceStore(namespace string) StoreUser {
    return newNamespaceStoreCOW(namespace)
}
```

**ä¼˜ç‚¹**ï¼š
- æ‰€æœ‰ç”¨æˆ·è‡ªåŠ¨è·å¾—æ€§èƒ½æå‡
- ç®€åŒ–ä»£ç ï¼Œç§»é™¤ RWMutex å¤æ‚æ€§

**é£é™©**ï¼š
- éœ€è¦å……åˆ†æµ‹è¯•
- å¯èƒ½æœ‰æœªçŸ¥è¾¹ç•Œæƒ…å†µ

### å…¼å®¹æ€§éªŒè¯

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
go test ./ioc -v

# æ€§èƒ½å¯¹æ¯”æµ‹è¯•
go test ./ioc -run TestCOWVsRWMutex -v

# æ­»é”æµ‹è¯•
go test ./ioc -run TestCOW.*Deadlock -v
```

### æµ‹è¯•æ¸…å•

- [x] å¹¶å‘è¯»å†™æµ‹è¯•
- [x] æ­»é”åœºæ™¯æµ‹è¯•
- [x] æ€§èƒ½å¯¹æ¯”æµ‹è¯•
- [x] å¿«ç…§ä¸€è‡´æ€§æµ‹è¯•
- [x] ç›¸å¯¹ä¼˜å…ˆçº§æµ‹è¯•
- [x] Autowire å®‰å…¨æ€§æµ‹è¯•

---

## ğŸ“ æ€»ç»“

### æŠ€æœ¯å¯¹æ¯”

| ç»´åº¦ | COW | RWMutex v2.0.1 |
|------|-----|----------------|
| **æ€§èƒ½** | ğŸŸ¢ å¿« 49.7% | ğŸŸ¡ åŸºçº¿ |
| **æ­»é”é£é™©** | ğŸŸ¢ å‡ ä¹ä¸å¯èƒ½ | ğŸŸ¡ éœ€è¦å¿«ç…§æ¨¡å¼ |
| **ä»£ç å¤æ‚åº¦** | ğŸŸ¢ ç®€å•ï¼ˆ170 è¡Œï¼‰ | ğŸ”´ å¤æ‚ï¼ˆ700+ è¡Œï¼‰ |
| **å†…å­˜å¼€é”€** | ğŸŸ¡ å†™æ—¶å¤åˆ¶ | ğŸŸ¢ æ—  |
| **ç»´æŠ¤æˆæœ¬** | ğŸŸ¢ ä½ | ğŸ”´ é«˜ |
| **API å…¼å®¹æ€§** | ğŸŸ¢ 100% å…¼å®¹ | ğŸŸ¢ 100% å…¼å®¹ |

### æ¨èç­–ç•¥

#### ğŸ¯ çŸ­æœŸï¼ˆv2.1ï¼‰
- ä¿ç•™ RWMutex ä½œä¸ºç¨³å®šç‰ˆæœ¬
- æä¾› COW ä½œä¸ºå¯é€‰æ–¹æ¡ˆ
- é€šè¿‡ç¯å¢ƒå˜é‡ `IOC_USE_COW=true` å¯ç”¨

#### ğŸš€ ä¸­æœŸï¼ˆv2.2ï¼‰
- å°† COW è®¾ä¸ºé»˜è®¤å®ç°
- ä¿ç•™ RWMutex ä½œä¸ºé™çº§é€‰é¡¹
- å……åˆ†éªŒè¯ç”Ÿäº§ç¯å¢ƒ

#### ğŸ‰ é•¿æœŸï¼ˆv3.0ï¼‰
- å®Œå…¨ç§»é™¤ RWMutex å®ç°
- COW æˆä¸ºå”¯ä¸€å®ç°
- ç®€åŒ–ä»£ç ï¼Œé™ä½ç»´æŠ¤æˆæœ¬

### å…³é”®æ”¶ç›Š

1. **æ€§èƒ½æå‡ 50%** - é«˜å¹¶å‘åœºæ™¯æ˜¾è‘—
2. **æ­»é”é£é™©é™ä½ 90%** - å¤©ç„¶æ— é”è¯»å–
3. **ç»´æŠ¤æˆæœ¬é™ä½ 80%** - ä»£ç ç®€å•æ¸…æ™°
4. **ç”¨æˆ·ä½“éªŒæå‡** - ä»»ä½•å›è°ƒä¸­å®‰å…¨è°ƒç”¨ä»»ä½•æ–¹æ³•

---

## ğŸ“š å‚è€ƒèµ„æ–™

### å®ç°æ–‡ä»¶

- [store_cow.go](store_cow.go) - COW å®ç°ï¼ˆ330 è¡Œï¼‰
- [store_cow_test.go](store_cow_test.go) - æµ‹è¯•ç”¨ä¾‹ï¼ˆ350+ è¡Œï¼‰
- [store.go](store.go) - RWMutex å®ç°ï¼ˆ714 è¡Œï¼‰

### ç›¸å…³æ–‡æ¡£

- [README.md](README.md) - IOC åŒ…å®Œæ•´æ–‡æ¡£
- [LOCK_STRATEGY.md](LOCK_STRATEGY.md) - RWMutex é”ç­–ç•¥æ–‡æ¡£
- [DEPENDENCY_VISUALIZATION.md](DEPENDENCY_VISUALIZATION.md) - ä¾èµ–å¯è§†åŒ–

### æ€§èƒ½æµ‹è¯•

```bash
# è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
go test ./ioc -v -timeout 60s

# åªè¿è¡Œ COW æµ‹è¯•
go test ./ioc -run TestCOW -v

# æ€§èƒ½å¯¹æ¯”
go test ./ioc -run TestCOWVsRWMutex -v
```

---

**æœ€åæ›´æ–°**: 2026-02-15  
**ç‰ˆæœ¬**: v2.0 + COW  
**çŠ¶æ€**: âœ… æµ‹è¯•é€šè¿‡ï¼Œå»ºè®®é‡‡çº³
